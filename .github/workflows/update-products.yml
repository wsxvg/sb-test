name: è‡ªåŠ¨æ›´æ–°å•†å“æ•°æ®

on:
  # å®šæ—¶ä»»åŠ¡ï¼šæ¯å¤©åŒ—äº¬æ—¶é—´å‡Œæ™¨ 5:00ï¼ˆUTC 21:00ï¼‰
  schedule:
    - cron: '0 21 * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  update-products:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: è®¾ç½® Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      # 3. å®‰è£…ä¾èµ–
      - name: å®‰è£… Python ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests urllib3
      
      # 4. è¿è¡Œçˆ¬è™«è„šæœ¬
      - name: è¿è¡Œçˆ¬è™«æŠ“å–å•†å“æ•°æ®
        run: |
          python demo.py
        continue-on-error: false
      
      # 5. æ£€æŸ¥æ•°æ®æœ‰æ•ˆæ€§
      - name: æ£€æŸ¥ç”Ÿæˆçš„æ•°æ®
        run: |
          if [ ! -f "products_db.json" ]; then
            echo "é”™è¯¯ï¼šproducts_db.json æ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          fi
          
          # æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆè‡³å°‘åº”è¯¥æœ‰ 50KBï¼‰
          file_size=$(stat -f%z "products_db.json" 2>/dev/null || stat -c%s "products_db.json")
          if [ "$file_size" -lt 50000 ]; then
            echo "é”™è¯¯ï¼šproducts_db.json æ–‡ä»¶å¤ªå°ï¼Œå¯èƒ½æ•°æ®ä¸å®Œæ•´"
            exit 1
          fi
          
          echo "æ•°æ®æ£€æŸ¥é€šè¿‡ï¼Œæ–‡ä»¶å¤§å°: $file_size å­—èŠ‚"
      
      # 6. æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
      - name: æ£€æŸ¥æ•°æ®å˜åŒ–
        id: check_changes
        run: |
          if git diff --quiet products_db.json; then
            echo "æ²¡æœ‰æ•°æ®å˜åŒ–"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "æ£€æµ‹åˆ°æ•°æ®å˜åŒ–"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # ç»Ÿè®¡å˜åŒ–
            added=$(git diff --numstat products_db.json | awk '{print $1}')
            deleted=$(git diff --numstat products_db.json | awk '{print $2}')
            echo "æ–°å¢è¡Œæ•°: $added, åˆ é™¤è¡Œæ•°: $deleted"
          fi
      
      # 7. æäº¤å¹¶æ¨é€æ›´æ”¹
      - name: æäº¤æ›´æ–°
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"
          
          # è·å–å½“å‰æ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
          current_time=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
          
          git add products_db.json
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°å•†å“æ•°æ® - $current_time"
          git push
      
      # 8. è¾“å‡ºå®Œæˆä¿¡æ¯
      - name: å®Œæˆ
        run: |
          if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
            echo "âœ… å•†å“æ•°æ®å·²æ›´æ–°å¹¶æ¨é€åˆ°ä»“åº“"
          else
            echo "â„¹ï¸ å•†å“æ•°æ®æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          fi
