<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="no-referrer">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æ±‡å‹æœºç”µ">
    <link rel="manifest" href="/sb-test/manifest.json">
    <title>æ±‡å‹æœºç”µå•†åŸ</title>
    <style>
        :root { --primary: #3296F0; --orange: #FF7033; --bg: #F7F7F7; --border: #eeeeee; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: #333; font-size: 14px; }

        /* --- é¡¶éƒ¨å¤åˆ» (æ ¹æ®å›¾ä¸€) --- */
        .top-nav { position: fixed; top: 0; width: 100%; height: 50px; background: white; z-index: 1000; display: none; align-items: center; padding: 0 12px; gap: 10px; border-bottom: 1px solid var(--border); }
        .top-nav.show { display: flex; }
        
        /* é¦–é¡µé¡¶éƒ¨ */
        .top-nav.home-mode { justify-content: space-between; }
        .top-nav.home-mode .logo { height: 34px; }
        .top-nav.home-mode .right-icons { display: flex; gap: 15px; align-items: center; }
        .top-nav.home-mode .right-icons img { width: 24px; height: 24px; }
        
        /* åˆ†ç±»é¡µé¡¶éƒ¨ */
        .top-nav.category-mode .logo-circle { width: 32px; height: 32px; flex-shrink: 0; }
        .top-nav.category-mode .logo-circle img { width: 100%; height: 100%; object-fit: contain; }
        .top-nav.category-mode .search-wrap { flex: 1; background: #F2F3F5; height: 34px; border-radius: 17px; display: flex; align-items: center; padding: 0 15px; gap: 8px; }
        .top-nav.category-mode .search-wrap::before { content: 'ğŸ”'; color: #999; font-size: 16px; }
        .top-nav.category-mode .search-wrap input { background: none; border: none; width: 100%; font-size: 13px; color: #333; outline: none; }
        .top-nav.category-mode .search-wrap input::placeholder { color: #999; }
        .top-nav.category-mode .scan-btn { width: 24px; height: 24px; opacity: 0.7; flex-shrink: 0; }

        /* --- é¡µé¢åˆ‡æ¢ --- */
        .page { display: none !important; padding-top: 50px; padding-bottom: 60px; min-height: 100vh; position: relative; z-index: 1; }
        .page.active { display: block !important; }
        .page#homePage { padding-top: 0; }
        .page#categoryPage { padding-top: 0; }

        /* --- åˆ†ç±»é¡µ (æ·±åº¦å¤åˆ»å›¾ä¸€) --- */
        .cat-container { display: flex; height: calc(100vh - 110px); background: white; margin-top: 50px; }
        .cat-left { width: 95px; background: #F7F7F7; overflow-y: auto; }
        .cat-item { padding: 18px 10px; font-size: 13px; text-align: center; color: #666; border-left: 3px solid transparent; line-height: 1.2; }
        .cat-item.active { background: white; color: var(--primary); border-left-color: var(--primary); font-weight: bold; }
        
        .cat-right { flex: 1; overflow-y: auto; padding: 0 15px; }
        .sub-title { font-size: 14px; font-weight: bold; padding: 15px 0 10px; background: white; position: sticky; top: 0; z-index: 5; }
        .sub-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px 10px; padding-bottom: 20px; align-items: start; }
        .sub-box { text-align: center; display: flex; flex-direction: column; align-items: center; }
        .sub-box img { width: 70px; height: 70px; object-fit: contain; background: #f9f9f9; border-radius: 4px; display: block; }
        .sub-box p { font-size: 11px; margin-top: 5px; color: #333; line-height: 1.3; word-break: break-all; min-height: 30px; display: flex; align-items: center; justify-content: center; text-align: center; }

        /* --- å•†å“è¯¦æƒ…é¡µ (æ‰¾å›åŸæ¥çš„åŠŸèƒ½) --- */
        .detail-layer { display: none; position: fixed; inset: 0; background: white; z-index: 3000; overflow-y: auto; }
        .detail-layer.active { display: block; }
        .detail-header { height: 44px; display: flex; align-items: center; padding: 0 15px; border-bottom: 1px solid #eee; position: sticky; top: 0; background: white; }
        .back-icon { font-size: 24px; margin-right: 15px; cursor: pointer; }

        /* --- åº•éƒ¨å¯¼èˆª --- */
        .tabbar { position: fixed; bottom: 0; width: 100%; height: 55px; background: white; border-top: 1px solid #ddd; display: flex; z-index: 2000; }
        .tab-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; color: #777; }
        .tab-btn img { width: 24px; height: 24px; margin-bottom: 2px; }
        .tab-btn.active { color: var(--primary); }

        /* è°ƒè¯•ï¼šç¡®ä¿å†…å®¹å¯è§ */
        #homePage { background: white !important; min-height: 100vh !important; }
        #homeContent { min-height: 100vh !important; display: block !important; width: 100% !important; }

        /* --- é¦–é¡µç»„ä»¶ --- */
        .home-row { background: white; margin-bottom: 8px; width: 100%; display: block; }
        .row-banner img { width: 100%; display: block; }
        .row-notice { padding: 10px 15px; display: flex; align-items: center; font-size: 13px; }
        .notice-tag { color: #E64340; font-weight: bold; padding-right: 10px; border-right: 1px solid #eee; margin-right: 10px; }

        /* é€šç”¨å•†å“å¡ç‰‡ */
        .prod-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 8px; background: var(--bg); }
        .prod-card { background: white; padding: 10px; border-radius: 8px; display: block; }
        .prod-card img { width: 100%; aspect-ratio: 1; object-fit: contain; display: block; }
        .prod-price { color: #ff5000; font-weight: bold; font-size: 16px; margin-top: 5px; }

        /* å›¾ç‰‡æ‡’åŠ è½½å ä½ */
        img[data-src] { background: #f0f0f0; }
        img.lazy-loading { opacity: 0.6; }
        img.lazy-loaded { animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* å•†å“åˆ—è¡¨æ ·å¼ï¼ˆå›¾ç‰‡ä¸­çš„æ ·å¼ï¼‰ */
        .prod-list-item { display: flex; align-items: center; padding: 15px; background: white; border-bottom: 1px solid #f0f0f0; gap: 12px; }
        .prod-list-img { width: 80px; height: 80px; object-fit: contain; flex-shrink: 0; background: #f9f9f9; border-radius: 4px; }
        .prod-list-info { flex: 1; }
        .prod-list-name { font-size: 14px; font-weight: 500; color: #333; margin-bottom: 8px; line-height: 1.4; }
        .prod-list-detail { font-size: 11px; color: #999; line-height: 1.6; }
        .prod-list-price { color: #ff5000; font-size: 16px; font-weight: bold; margin-top: 5px; }
        .prod-list-add { width: 36px; height: 36px; background: #ff5000; border-radius: 50%; color: white; font-size: 24px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }

        /* --- å•†å“åˆ—è¡¨é¡µï¼ˆç‹¬ç«‹é¡µé¢ï¼‰ --- */
        .product-list-page { display: none; position: fixed; inset: 0; background: white; z-index: 2500; flex-direction: column; }
        .product-list-page.active { display: flex; }
        .product-list-header { height: 50px; background: white; border-bottom: 1px solid #eee; display: flex; align-items: center; padding: 0 15px; gap: 10px; flex-shrink: 0; }
        .product-list-back { font-size: 24px; color: #333; cursor: pointer; }
        .product-list-search { flex: 1; background: #F2F3F5; height: 34px; border-radius: 17px; display: flex; align-items: center; padding: 0 15px; }
        .product-list-search input { background: none; border: none; width: 100%; font-size: 13px; outline: none; }
        .product-list-sort { height: 44px; background: white; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; padding: 0 15px; gap: 30px; flex-shrink: 0; }
        .sort-item { font-size: 14px; color: #666; cursor: pointer; }
        .sort-item.active { color: #FF7033; font-weight: bold; }
        .product-list-content { flex: 1; overflow-y: auto; background: #f5f5f5; }

        /* å“ç‰Œç­›é€‰å¼¹çª— */
        .brand-filter-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 3000; }
        .brand-filter-overlay.active { display: block; }
        .brand-filter-panel { position: absolute; bottom: 0; left: 0; right: 0; background: white; border-radius: 12px 12px 0 0; max-height: 70vh; display: flex; flex-direction: column; }
        .brand-filter-header { padding: 15px; border-bottom: 1px solid #f0f0f0; font-size: 16px; font-weight: bold; text-align: center; }
        .brand-filter-content { flex: 1; overflow-y: auto; padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .brand-item { padding: 12px; text-align: center; background: #f5f5f5; border-radius: 6px; font-size: 14px; color: #333; cursor: pointer; }
        .brand-item.active { background: #FFE8E0; color: var(--orange); font-weight: bold; }
        .brand-filter-footer { display: flex; border-top: 1px solid #f0f0f0; }
        .brand-filter-btn { flex: 1; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 16px; cursor: pointer; }
        .brand-filter-btn.reset { color: #666; background: white; }
        .brand-filter-btn.confirm { color: white; background: var(--orange); font-weight: bold; }

        .empty-cart { text-align: center; padding-top: 100px; color: #999; }
    </style>
</head>
<body>

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="top-nav" id="topNav" style="display: none;">

    <!-- 1. é¦–é¡µ -->
    <div id="homePage" class="page active">
        <div id="homeContent"></div>
    </div>

    <!-- 2. åˆ†ç±»é¡µ -->
    <div id="categoryPage" class="page">
        <div class="cat-container">
            <div id="catLeft" class="cat-left"></div>
            <div id="catRight" class="cat-right">
                <div id="catDynamicContent"></div>
            </div>
        </div>
    </div>

    <!-- 3. è´­ç‰©è½¦ -->
    <div id="cartPage" class="page">
        <div class="empty-cart">
            <img src="https://kaifa.sintoyu.cn/xcximages/cart-empty2.png" width="180"><br>
            è´­ç‰©è½¦ç©ºç©ºå¦‚ä¹Ÿ~~
        </div>
    </div>

    <!-- 4. æˆ‘çš„ -->
    <div id="mePage" class="page" style="padding-top: 0;">
        <div style="background: var(--primary); padding: 40px 20px; color: white; display: flex; align-items: center; gap: 15px;">
            <div style="width: 60px; height: 60px; border-radius: 50%; background: #eee; border: 2px solid white;"></div>
            <div>
                <div style="font-size: 18px; font-weight: bold;">17826038535</div>
                <div style="font-size: 12px; opacity: 0.8;">æ™®é€šä¼šå‘˜</div>
            </div>
        </div>
        <div style="background:white; margin-top:10px; padding:20px; text-align:center; color:#999;">ä¸ªäººä¸­å¿ƒåŠŸèƒ½å¼€å‘ä¸­</div>
    </div>

    <!-- å•†å“è¯¦æƒ…å±‚ (æ‰¾å›çš„åŠŸèƒ½) -->
    <div id="detailPage" class="detail-layer">
        <div class="detail-header">
            <span class="back-icon" onclick="closeDetail()">â†</span>
            <strong id="detTitle">å•†å“è¯¦æƒ…</strong>
        </div>
        <div style="padding: 15px;">
            <img id="detImg" src="" style="width:100%; border-radius: 8px;">
            <div id="detPrice" style="color: #ff5000; font-size: 24px; font-weight: bold; margin: 15px 0;"></div>
            <div id="detName" style="font-size: 18px; font-weight: bold; margin-bottom: 20px;"></div>
            <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; line-height: 2;">
                <p>ç¼–ç ï¼š<span id="detNum"></span></p>
                <p>åŒ…è£…ï¼š<span id="detSale"></span></p>
                <p>èµ·è®¢ï¼š<span id="detMin"></span></p>
            </div>
        </div>
    </div>

    <!-- å•†å“åˆ—è¡¨é¡µï¼ˆç‹¬ç«‹é¡µé¢ï¼‰ -->
    <div id="productListPage" class="product-list-page">
        <div class="product-list-header">
            <span class="product-list-back" onclick="closeProductList()">â†</span>
            <div class="product-list-search">
                <span style="color:#999; margin-right:8px;">ğŸ”</span>
                <input type="text" placeholder="è¾“å…¥å“å/æ¡ç /æ‹¼éŸ³ç " onkeypress="handleProductListSearch(event)">
            </div>
        </div>
        <div class="product-list-sort">
            <div class="sort-item active" data-sort="default" onclick="sortProducts('default')">ç»¼åˆ</div>
            <div class="sort-item" data-sort="price" onclick="togglePriceSort()">ä»·æ ¼ â–²</div>
            <div class="sort-item" data-sort="hot" onclick="sortProducts('hot')">çƒ­åº¦</div>
            <div class="sort-item" data-sort="brand" onclick="openBrandFilter()">å“ç‰Œ</div>
        </div>
        <div class="product-list-content" id="productListContent"></div>
    </div>

    <!-- å“ç‰Œç­›é€‰å¼¹çª— -->
    <div id="brandFilterOverlay" class="brand-filter-overlay" onclick="closeBrandFilter()">
        <div class="brand-filter-panel" onclick="event.stopPropagation()">
            <div class="brand-filter-header">é€‰æ‹©å“ç‰Œ</div>
            <div class="brand-filter-content" id="brandFilterContent"></div>
            <div class="brand-filter-footer">
                <div class="brand-filter-btn reset" onclick="resetBrandFilter()">é‡ç½®</div>
                <div class="brand-filter-btn confirm" onclick="confirmBrandFilter()">ç¡®å®š</div>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨ TabBar -->
    <div class="tabbar">
        <div class="tab-btn active" onclick="switchTab('home', this)">
            <img src="/sb-test/images/home_un.png"><span>é¦–é¡µ</span>
        </div>
        <div class="tab-btn" onclick="switchTab('category', this)">
            <img src="/sb-test/images/category_un.png"><span>åˆ†ç±»</span>
        </div>
        <div class="tab-btn" onclick="switchTab('cart', this)">
            <img src="/sb-test/images/cart_un.png"><span>è´­ç‰©è½¦</span>
        </div>
        <div class="tab-btn" onclick="switchTab('me', this)">
            <img src="/sb-test/images/user_un.png"><span>æˆ‘</span>
        </div>
    </div>

    <script>
        const IMG_HOST = "https://kaifa.sintoyu.cn";
        let db = null, homeData = null;

        // ===== å·¥å…·å‡½æ•° =====
        
        // ä»·æ ¼è®¡ç®—å‡½æ•°ï¼šåŠ ä»·30%å¹¶å‘ä¸Šå–æ•´
        function calculatePrice(price) {
            if (!price || price <= 0) return 0;
            return Math.ceil(price * 1.3);
        }
        
        // æ ¼å¼åŒ–ä»·æ ¼æ˜¾ç¤ºï¼ˆåŒ…å«å•ä½ï¼‰
        function formatPrice(price, unit) {
            const finalPrice = calculatePrice(price);
            return unit ? `Â¥${finalPrice}/${unit}` : `Â¥${finalPrice}`;
        }
        
        // é˜²æŠ–å‡½æ•°
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // å›¾ç‰‡æ‡’åŠ è½½è§‚å¯Ÿå™¨
        let lazyImageObserver = null;
        
        function initLazyLoad() {
            if ('IntersectionObserver' in window) {
                lazyImageObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            const src = img.getAttribute('data-src');
                            if (src) {
                                img.classList.add('lazy-loading');
                                img.src = src;
                                img.onload = () => {
                                    img.classList.remove('lazy-loading');
                                    img.classList.add('lazy-loaded');
                                    img.removeAttribute('data-src');
                                };
                                img.onerror = () => {
                                    img.src = '/sb-test/placeholder.svg';
                                    img.classList.remove('lazy-loading');
                                };
                            }
                            observer.unobserve(img);
                        }
                    });
                }, {
                    rootMargin: '50px' // æå‰ 50px å¼€å§‹åŠ è½½
                });
            }
        }

        function observeLazyImages(container) {
            if (!lazyImageObserver) return;
            const lazyImages = container.querySelectorAll('img[data-src]');
            lazyImages.forEach(img => lazyImageObserver.observe(img));
        }

        // ===== åˆå§‹åŒ– =====

        async function init() {
            try {
                console.log('å¼€å§‹åŠ è½½æ•°æ®...');
                const [p, h] = await Promise.all([
                    fetch('/sb-test/products_db.json').then(r => {
                        if (!r.ok) throw new Error('æ— æ³•åŠ è½½å•†å“æ•°æ®');
                        return r.json();
                    }),
                    fetch('/sb-test/home_config.json').then(r => {
                        if (!r.ok) throw new Error('æ— æ³•åŠ è½½é¦–é¡µé…ç½®');
                        return r.json();
                    })
                ]);
                
                db = p; 
                homeData = h;
                console.log('æ•°æ®åŠ è½½æˆåŠŸï¼Œå•†å“æ•°é‡:', db.products.length);
                
                // åˆå§‹åŒ–æ‡’åŠ è½½
                initLazyLoad();
                
                renderHome();
                renderCatMenu();
                
                // åˆå§‹åŒ–äº‹ä»¶å§”æ‰˜
                initEventDelegation();
                
                console.log('åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                document.getElementById('homeContent').innerHTML = `
                    <div style="padding: 40px 20px; text-align: center; color: #999;">
                        <p style="font-size: 16px; margin-bottom: 10px;">ğŸ˜” åŠ è½½å¤±è´¥</p>
                        <p style="font-size: 14px;">${error.message}</p>
                        <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 30px; background: var(--primary); color: white; border: none; border-radius: 4px; font-size: 14px;">é‡æ–°åŠ è½½</button>
                    </div>
                `;
            }
        }

        // --- é¦–é¡µæ¸²æŸ“ ---
        function renderHome() {
            try {
                console.log('å¼€å§‹æ¸²æŸ“é¦–é¡µ...');
                let html = '';
                let firstBanner = true;
                
                if (!homeData || !Array.isArray(homeData)) {
                    throw new Error('é¦–é¡µé…ç½®æ•°æ®æ ¼å¼é”™è¯¯');
                }
                
                homeData.forEach(row => {
                    if(row.type === 1 && row.data && row.data.length > 0) {
                        html += `<div class="home-row row-banner"><img src="/sb-test/${row.data[0].local}"></div>`;
                        // ç¬¬ä¸€å¼ å›¾ç‰‡åé¢æ·»åŠ å…¬å‘Š
                        if(firstBanner) {
                            html += `<div class="home-row row-notice"><span class="notice-tag">åº—é“ºå…¬å‘Š</span><marquee>æ¬¢è¿æ¥åˆ°æ±‡å‹æœºç”µæœ‰é™å…¬å¸</marquee></div>`;
                            firstBanner = false;
                        }
                    }
                });
                
                if (!db || !db.products || !Array.isArray(db.products)) {
                    throw new Error('å•†å“æ•°æ®æ ¼å¼é”™è¯¯');
                }
                
                html += `<div style="padding:10px; font-weight:bold;">ä¸ºæ‚¨æ¨è</div><div class="prod-grid" id="homeProductGrid">`;
                db.products.slice(0, 10).forEach(item => {
                    html += `<div class="prod-card" data-id="${item.id}">
                        <img data-src="${fixUrl(item.img)}" src="/sb-test/placeholder.svg" alt="${item.name}">
                        <div style="font-size:12px; margin:5px 0; height:34px; overflow:hidden;">${item.name}</div>
                        <div class="prod-price">${formatPrice(item.price, item.unit)}</div>
                    </div>`;
                });
                html += `</div>`;
                
                const homeContent = document.getElementById('homeContent');
                if (!homeContent) {
                    throw new Error('æ‰¾ä¸åˆ°é¦–é¡µå®¹å™¨å…ƒç´ ');
                }
                homeContent.innerHTML = html;
                
                // å¯åŠ¨æ‡’åŠ è½½
                observeLazyImages(homeContent);
                console.log('é¦–é¡µæ¸²æŸ“å®Œæˆ');
            } catch (error) {
                console.error('é¦–é¡µæ¸²æŸ“å¤±è´¥:', error);
                const homeContent = document.getElementById('homeContent');
                if (homeContent) {
                    homeContent.innerHTML = `
                        <div style="padding: 40px 20px; text-align: center; color: #999;">
                            <p style="font-size: 16px; margin-bottom: 10px;">ğŸ˜” é¡µé¢åŠ è½½å¤±è´¥</p>
                            <p style="font-size: 14px;">${error.message}</p>
                        </div>
                    `;
                }
            }
        }

        // --- åˆ†ç±»æ¸²æŸ“ (å›¾ä¸€é€»è¾‘) ---
        function renderCatMenu() {
            document.getElementById('catLeft').innerHTML = db.category_tree.map((c, i) => 
                `<div class="cat-item ${i===0?'active':''}" onclick="selectCat(${i})">${c.name}</div>`
            ).join('');
            selectCat(0);
        }

        function selectCat(idx) {
            // 1. é«˜äº®å·¦ä¾§é€‰ä¸­çš„ä¸€çº§åˆ†ç±»
            document.querySelectorAll('.cat-item').forEach((el, i) => el.classList.toggle('active', i === idx));
            
            const level1 = db.category_tree[idx];
            const container = document.getElementById('catDynamicContent');
            
            let html = '';
            
            // 2. éå†äºŒçº§åˆ†ç±»ï¼ˆsubsï¼‰ï¼Œæ¯”å¦‚"æ‰³æ‰‹ç±»"ã€"é’³ç±»å·¥å…·"
            if (level1.subs && level1.subs.length > 0) {
                level1.subs.forEach(sub => {
                    
                    // æ˜¾ç¤ºäºŒçº§åˆ†ç±»æ ‡é¢˜
                    html += `<div class="sub-title">${sub.name}</div>`;
                    
                    // å»ºç«‹ä¸‰çº§åˆ†ç±»çš„å›¾æ ‡ç½‘æ ¼
                    html += `<div class="sub-grid">`;
                    
                    // 3. éå†ä¸‰çº§åˆ†ç±»ï¼ˆchildrenï¼‰
                    if (sub.children && sub.children.length > 0) {
                        sub.children.forEach(child => {
                            // ä½¿ç”¨ data å±æ€§å­˜å‚¨åˆ†ç±»ä¿¡æ¯ï¼Œç§»é™¤ onclick
                            html += `
                                <div class="sub-box" data-gid="${child.id}" data-name="${child.name}">
                                    <img data-src="${fixUrl(child.img)}" src="/sb-test/placeholder.svg" alt="${child.name}">
                                    <p>${child.name}</p>
                                </div>`;
                        });
                    } else {
                        // å¦‚æœæ²¡æœ‰ä¸‰çº§åˆ†ç±»ï¼Œåˆ™æŠŠäºŒçº§åˆ†ç±»è‡ªå·±æ˜¾ç¤ºä¸ºä¸€ä¸ªå›¾æ ‡
                        html += `
                            <div class="sub-box" data-gid="${sub.id}" data-name="${sub.name}">
                                <img data-src="${fixUrl(sub.img)}" src="/sb-test/placeholder.svg" alt="${sub.name}">
                                <p>${sub.name}</p>
                            </div>`;
                    }
                    html += `</div>`; // å…³é—­ç½‘æ ¼
                });
            }
            
            container.innerHTML = html;
            
            // å¯åŠ¨æ‡’åŠ è½½
            observeLazyImages(container);
        }

        let currentCategoryId = null;
        let currentCategoryName = '';
        let currentSortType = 'default'; // default, price_asc, price_desc, hot, brand
        let selectedBrand = null; // å½“å‰é€‰ä¸­çš„å“ç‰Œ
        let availableBrands = []; // å½“å‰åˆ†ç±»ä¸‹å¯ç”¨çš„å“ç‰Œåˆ—è¡¨
        let currentProducts = []; // ç¼“å­˜å½“å‰æ˜¾ç¤ºçš„å•†å“åˆ—è¡¨ï¼ˆæœç´¢æˆ–åˆ†ç±»ç»“æœï¼‰
        
        function openProductList(gid, name) {
            console.log('æ‰“å¼€å•†å“åˆ—è¡¨ï¼Œåˆ†ç±»ID:', gid, 'åç§°:', name);
            
            currentCategoryId = gid;
            currentCategoryName = name;
            currentSortType = 'default';
            selectedBrand = null;
            
            // ä½¿ç”¨ gids æ•°ç»„è¿‡æ»¤å•†å“
            const filteredProducts = db.products.filter(p => p.gids && p.gids.includes(gid));
            console.log('æ‰¾åˆ°å•†å“æ•°é‡:', filteredProducts.length);
            
            // ç¼“å­˜å½“å‰å•†å“åˆ—è¡¨
            currentProducts = filteredProducts;
            
            // æå–å½“å‰åˆ†ç±»ä¸‹æ‰€æœ‰å“ç‰Œ
            const brandSet = new Set();
            filteredProducts.forEach(p => {
                if (p.brand && p.brand.trim()) {
                    brandSet.add(p.brand.trim());
                }
            });
            availableBrands = Array.from(brandSet).sort((a, b) => a.localeCompare(b, 'zh-CN'));
            
            renderProductList(filteredProducts);
            document.getElementById('productListPage').classList.add('active');
        }
        
        function renderProductList(products) {
            const container = document.getElementById('productListContent');
            
            if (!products || products.length === 0) {
                container.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">æš‚æ— å•†å“</div>';
                return;
            }
            
            // ä½¿ç”¨ DocumentFragment æé«˜æ€§èƒ½
            const fragment = document.createDocumentFragment();
            const tempDiv = document.createElement('div');
            
            products.forEach(p => {
                tempDiv.innerHTML = `
                    <div class="prod-list-item" data-id="${p.id}">
                        <img data-src="${fixUrl(p.img)}" src="/sb-test/placeholder.svg" class="prod-list-img" alt="${p.name}">
                        <div class="prod-list-info">
                            <div class="prod-list-name">${p.name}</div>
                            <div class="prod-list-detail">
                                <div>ç¼–ç ï¼š${p.num || 'æ— '}</div>
                                <div>åŒ…è£…ï¼š${p.sale_info || 'æ— '}</div>
                                <div>${p.min_qty || ''}</div>
                            </div>
                            <div class="prod-list-price">${formatPrice(p.price, p.unit)}</div>
                        </div>
                        <div class="prod-list-add">+</div>
                    </div>
                `;
                fragment.appendChild(tempDiv.firstElementChild);
            });
            
            container.innerHTML = '';
            container.appendChild(fragment);
            
            // å¯åŠ¨æ‡’åŠ è½½
            observeLazyImages(container);
        }
        
        function sortProducts(type) {
            if (!currentProducts || currentProducts.length === 0) return;
            
            // ä»ç¼“å­˜çš„å•†å“åˆ—è¡¨å¼€å§‹
            let products = [...currentProducts];
            
            // å¦‚æœæœ‰é€‰ä¸­çš„å“ç‰Œï¼Œå…ˆæŒ‰å“ç‰Œè¿‡æ»¤
            if (selectedBrand) {
                products = products.filter(p => p.brand && p.brand.trim() === selectedBrand);
            }
            
            // æ ¹æ®æ’åºç±»å‹æ’åº
            if (type === 'price_asc') {
                products.sort((a, b) => (a.price || 0) - (b.price || 0));
                currentSortType = 'price_asc';
            } else if (type === 'price_desc') {
                products.sort((a, b) => (b.price || 0) - (a.price || 0));
                currentSortType = 'price_desc';
            } else if (type === 'hot') {
                products.sort((a, b) => (b.hot || 0) - (a.hot || 0));
                currentSortType = 'hot';
            } else {
                // é»˜è®¤æ’åºï¼ˆæŒ‰IDï¼‰
                products.sort((a, b) => a.id - b.id);
                currentSortType = 'default';
            }
            
            // æ›´æ–°æ’åºæŒ‰é’®çŠ¶æ€
            updateSortButtons();
            
            // é‡æ–°æ¸²æŸ“å•†å“åˆ—è¡¨
            renderProductList(products);
        }
        
        function togglePriceSort() {
            if (currentSortType === 'price_asc') {
                sortProducts('price_desc');
            } else {
                sortProducts('price_asc');
            }
        }
        
        function updateSortButtons() {
            document.querySelectorAll('.sort-item').forEach(item => item.classList.remove('active'));
            
            if (currentSortType === 'default') {
                document.querySelector('.sort-item[data-sort="default"]').classList.add('active');
            } else if (currentSortType === 'price_asc' || currentSortType === 'price_desc') {
                const priceBtn = document.querySelector('.sort-item[data-sort="price"]');
                priceBtn.classList.add('active');
                priceBtn.textContent = currentSortType === 'price_asc' ? 'ä»·æ ¼ â–²' : 'ä»·æ ¼ â–¼';
            } else if (currentSortType === 'hot') {
                document.querySelector('.sort-item[data-sort="hot"]').classList.add('active');
            }
            
            // å“ç‰ŒæŒ‰é’®ç‰¹æ®Šå¤„ç†
            const brandBtn = document.querySelector('.sort-item[data-sort="brand"]');
            if (selectedBrand) {
                brandBtn.classList.add('active');
            }
        }
        
        function openBrandFilter() {
            // æ¸²æŸ“å“ç‰Œåˆ—è¡¨ï¼Œä½¿ç”¨ data å±æ€§é¿å… XSS
            const html = availableBrands.map(brand => 
                `<div class="brand-item ${selectedBrand === brand ? 'active' : ''}" data-brand="${brand.replace(/"/g, '&quot;')}">${brand}</div>`
            ).join('');
            
            document.getElementById('brandFilterContent').innerHTML = html || '<div style="grid-column: 1/-1; text-align:center; color:#999;">æš‚æ— å“ç‰Œ</div>';
            document.getElementById('brandFilterOverlay').classList.add('active');
        }
        
        function selectBrand(brand) {
            // åˆ‡æ¢é€‰ä¸­çŠ¶æ€
            const items = document.querySelectorAll('.brand-item');
            let found = false;
            
            items.forEach(item => {
                if (item.getAttribute('data-brand') === brand) {
                    if (item.classList.contains('active')) {
                        item.classList.remove('active');
                        selectedBrand = null;
                    } else {
                        items.forEach(i => i.classList.remove('active'));
                        item.classList.add('active');
                        selectedBrand = brand;
                    }
                    found = true;
                }
            });
        }
        
        function resetBrandFilter() {
            selectedBrand = null;
            document.querySelectorAll('.brand-item').forEach(item => item.classList.remove('active'));
        }
        
        function confirmBrandFilter() {
            closeBrandFilter();
            sortProducts(currentSortType); // é‡æ–°åº”ç”¨å½“å‰æ’åº
        }
        
        function closeBrandFilter() {
            document.getElementById('brandFilterOverlay').classList.remove('active');
        }
        
        function closeProductList() {
            document.getElementById('productListPage').classList.remove('active');
        }

        // --- æ‰¾å›çš„åŠŸèƒ½ï¼šè¯¦æƒ…é¡µ ---
        function openDetail(id) {
            const p = db.products.find(x => x.id == id);
            if(!p) return;
            document.getElementById('detImg').src = fixUrl(p.img);
            document.getElementById('detName').textContent = p.name;
            document.getElementById('detPrice').textContent = formatPrice(p.price, p.unit);
            document.getElementById('detNum').textContent = p.num || 'æ— ';
            document.getElementById('detSale').textContent = p.sale_info || 'æ— ';
            document.getElementById('detMin').textContent = p.min_qty || 'æ— ';
            document.getElementById('detailPage').classList.add('active');
        }

        function closeDetail() { document.getElementById('detailPage').classList.remove('active'); }

        function switchTab(type, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
            document.getElementById(type + 'Page').classList.add('active');
            el.classList.add('active');
            
            const topNav = document.getElementById('topNav');
            if (type === 'me' || type === 'home') {
                topNav.style.display = 'none';
            } else if (type === 'category') {
                // åˆ†ç±»é¡µæ¨¡å¼
                topNav.style.display = 'flex';
                topNav.className = 'top-nav show category-mode';
                topNav.innerHTML = `
                    <div class="logo-circle">
                        <img src="/sb-test/images/circle-class-down.png" alt="åˆ†ç±»">
                    </div>
                    <div class="search-wrap">
                        <input type="text" id="searchInput" placeholder="æœç´¢äº§å“" onkeypress="handleSearch(event)">
                    </div>
                    <img src="/sb-test/images/home-scan.png" class="scan-btn" alt="æ‰«ç ">
                `;
            } else {
                topNav.style.display = 'flex';
            }
        }

        function fixUrl(u) {
            if (!u || u === "") return '/sb-test/placeholder.svg';
            
            // å¦‚æœå·²ç»æ˜¯å®Œæ•´çš„ http æˆ– https å¼€å¤´äº†ï¼Œç›´æ¥ç”¨ï¼Œä¸è¦å†åŠ å‰ç¼€ï¼
            if (u.toLowerCase().startsWith('http')) {
                return u;
            }
            
            // åªæœ‰å½“å®ƒæ˜¯ç›¸å¯¹è·¯å¾„ï¼ˆæ¯”å¦‚ /UploadFiles/...ï¼‰æ—¶ï¼Œæ‰æ‹¼æ¥å‰ç¼€
            return IMG_HOST + (u.startsWith('/') ? '' : '/') + u;
        }

        // æœç´¢å‡½æ•°ï¼ˆå¸¦é˜²æŠ–ï¼‰
        const debouncedSearch = debounce((kw) => {
            if (!kw) return;
            
            const results = db.products.filter(p => 
                p.name.toLowerCase().includes(kw) || 
                (p.num && p.num.toLowerCase().includes(kw)) ||
                (p.brand && p.brand.toLowerCase().includes(kw))
            );
            
            // ä½¿ç”¨å•†å“åˆ—è¡¨é¡µå±•ç¤ºæœç´¢ç»“æœ
            currentCategoryId = 'search';
            currentCategoryName = `æœç´¢"${kw}"`;
            currentSortType = 'default';
            selectedBrand = null;
            
            // ç¼“å­˜æœç´¢ç»“æœ
            currentProducts = results;
            
            // æå–æœç´¢ç»“æœä¸­çš„å“ç‰Œ
            const brandSet = new Set();
            results.forEach(p => {
                if (p.brand && p.brand.trim()) {
                    brandSet.add(p.brand.trim());
                }
            });
            availableBrands = Array.from(brandSet).sort((a, b) => a.localeCompare(b, 'zh-CN'));
            
            renderProductList(results);
            document.getElementById('productListPage').classList.add('active');
        }, 300); // 300ms é˜²æŠ–

        function handleSearch(e) {
            if(e.key === 'Enter') {
                const kw = e.target.value.trim().toLowerCase();
                debouncedSearch(kw);
            }
        }
        
        function handleProductListSearch(e) {
            if(e.key === 'Enter') {
                const kw = e.target.value.trim().toLowerCase();
                if (!kw) return;
                
                const results = db.products.filter(p => 
                    p.name.toLowerCase().includes(kw) || 
                    (p.num && p.num.toLowerCase().includes(kw)) ||
                    (p.brand && p.brand.toLowerCase().includes(kw))
                );
                
                // æ›´æ–°æœç´¢çŠ¶æ€
                currentCategoryId = 'search';
                currentCategoryName = `æœç´¢"${kw}"`;
                currentSortType = 'default';
                selectedBrand = null;
                
                // ç¼“å­˜æœç´¢ç»“æœ
                currentProducts = results;
                
                // æå–æœç´¢ç»“æœä¸­çš„å“ç‰Œ
                const brandSet = new Set();
                results.forEach(p => {
                    if (p.brand && p.brand.trim()) {
                        brandSet.add(p.brand.trim());
                    }
                });
                availableBrands = Array.from(brandSet).sort((a, b) => a.localeCompare(b, 'zh-CN'));
                
                // é‡ç½®æ’åºæŒ‰é’®
                updateSortButtons();
                
                renderProductList(results);
            }
        }

        // ===== äº‹ä»¶å§”æ‰˜åˆå§‹åŒ– =====
        function initEventDelegation() {
            // é¦–é¡µå•†å“å¡ç‰‡ç‚¹å‡»
            document.getElementById('homeContent').addEventListener('click', (e) => {
                const card = e.target.closest('.prod-card');
                if (card) {
                    const id = card.getAttribute('data-id');
                    if (id) openDetail(parseInt(id));
                }
            });

            // åˆ†ç±»é¡µå›¾æ ‡ç‚¹å‡»
            document.getElementById('catDynamicContent').addEventListener('click', (e) => {
                const box = e.target.closest('.sub-box');
                if (box) {
                    const gid = box.getAttribute('data-gid');
                    const name = box.getAttribute('data-name');
                    if (gid && name) openProductList(parseInt(gid), name);
                }
            });

            // å•†å“åˆ—è¡¨é¡µå•†å“ç‚¹å‡»
            document.getElementById('productListContent').addEventListener('click', (e) => {
                const item = e.target.closest('.prod-list-item');
                if (item) {
                    const id = item.getAttribute('data-id');
                    if (id) openDetail(parseInt(id));
                }
            });

            // å“ç‰Œç­›é€‰ç‚¹å‡»
            document.getElementById('brandFilterContent').addEventListener('click', (e) => {
                const brandItem = e.target.closest('.brand-item');
                if (brandItem) {
                    const brand = brandItem.getAttribute('data-brand');
                    if (brand) selectBrand(brand);
                }
            });
        }

        init();
    </script>
</body>
</html>